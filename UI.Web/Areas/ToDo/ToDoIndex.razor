@using System.Security.Claims;
@using global::ToDo.Data.Entities;

<AuthorizeView>
    <NotAuthorized>
        <h4>Bitte einloggen!</h4>
        <div>
            <a href=@(NavigationManager.BaseUri + "Identity/Account/Login")>Login Page</a>
        </div>
    </NotAuthorized>
    <Authorized >
        @{
            _currentUser = context.User;
        }

        <h4>Meine ToDo's</h4>

        @if (_myToDos.Any())
        {
            <div class="row p-1 mb-3 fw-bold">
                <div class="col-8">
                    Bezeichnung
                </div>

                <div class="col">
                    Kategorie
                </div>

                <div class="col">
                    Deadline
                </div>
            </div>

            @foreach (var item in _myToDos)
            {
                <div class="todo-card">
                    <ToDoItem_Component Model=item Level=0 OnRemove=@((item) => HandleRemove(item))></ToDoItem_Component>
                </div>
            }
        }

        @if (newSubModel != null)
        {
            <ToDoNew Model=newSubModel OnChange=@((value) => HandleNewChange(value))></ToDoNew>
        }

        <div class="row">
            <div class="btn-group col-3" role="group">
                <button @onclick="@(() => CreateNew())" class="btn btn-outline-primary">Hinzufügen</button>
            </div>
        </div>
    </Authorized>
</AuthorizeView>

@code {
    private ToDoItem? newSubModel = null;
    private List<ToDoItem> _myToDos = new List<ToDoItem>();
    private ClaimsPrincipal _currentUser { get; set; } = new ClaimsPrincipal();

    protected override async Task OnInitializedAsync()
    {
        //_currentUser.Claims.Type "nameidentifier"
        //http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier
        //Value:      5332a925-641b-4946-9ab3-c8597b9f7b9f
        // Id aus DB: 5332a925-641b-4946-9ab3-c8597b9f7b9f

        using var repository = DbFactory.CreateDbContext();

        _myToDos = (await repository.ToDoItems.Include(todo => todo.Category).OrderBy(todo => todo.Order).ThenBy(todo => todo.Deadline).ToListAsync()).Where(todo => todo.Parent == null).ToList();
    }

    private void CreateNew()
    {
        newSubModel = new ToDoItem
            {
                Parent = null,
                CategoryId = null
            };
    }

    private void HandleNewChange(ToDoItem? item)
    {
        newSubModel = null;
        if (item != null)
            _myToDos.Add(item);

        StateHasChanged();
    }

    private void HandleRemove(ToDoItem todoItem)
    {
        _myToDos.Remove(todoItem);
        StateHasChanged();
    }
}
