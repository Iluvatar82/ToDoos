@page "/categories/"
@using System.ComponentModel.DataAnnotations;
@using Core.Validation

<h4>Kategorien</h4>

@if (AllCategories.Any())
{
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th scope="col">Bezeichnung</th>
                <th scope="col">Icon</th>
                <th scope="col">Farbe</th>
                <th scope="col"></th>
            </tr>
        </thead>

        <tbody>
            @foreach (var category in AllCategories)
            {
                var currentIndex = AllCategories.IndexOf(category);
                <tr class="align-middle">
                    <td @onclick=@(() => BezeichnungEditEnabled = currentIndex)>
                        @if (BezeichnungEditEnabled != currentIndex)
                        {
                            <span class="col">@category.Bezeichnung</span>
                        }
                        else
                        {
                            <EditForm Model=@category>
                                <DataAnnotationsValidator />

                                <input type="text" @bind-value=category.Bezeichnung id="bezeichnung" class="form-control" @onkeyup=@(async (KeyboardEventArgs key) => { if(key.Code == "Enter") await HandleBezeichnungChange(context, category); }) @onblur=@(() => HandleBezeichnungChange(context, category)) />
                                <ValidationMessage For=@(() => category.Bezeichnung) />
                            </EditForm>
                        }
                    </td>

                    <td class="p-0 small-column">
                        <IconsBrowser Selected=@category.Icon IconDisplayOnly=true SelectedChanged=@(async (icon) => await IconChanged(category, icon)) />
                    </td>

                    <td class="p-0">
                        <input type="color" @bind-value=category.RGB_A class="w-100" @onblur=@(() => UpdateColor(category, category.RGB_A)) />
                    </td>

                    <td class="p-0 small-column">
                        <span class="px-2 fa fa-xmark opacity-25" aria-hidden="true" @onclick=@(async () => await RemoveCategory(currentIndex))></span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="form-label">Es gibt noch keine Kategorie</div>
}

<div class="row">
    <div class="btn-group col-3" role="group">
        <button @onclick=@NavigateToNew class="btn btn-outline-primary">Hinzufügen</button>
    </div>
</div>

@code {
    private int BezeichnungEditEnabled { get; set; } = -1;

    [Parameter]
    public Guid? ListId { get; set; }

    [Parameter]
    public List<Category> AllCategories { get; set; } = new List<Category>();

    [CascadingParameter]
    public IdentityUser? User { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (User == null && ListId == null)
            return;

        if (ListId != null)
        {
            if (!AllCategories.Any())
                AllCategories = await CategoryRepository.GetAllCategoriesAsync(c => c.ListId == ListId);
        }
        else
        {
            var guidId = Guid.Parse(User!.Id);
            AllCategories = await CategoryRepository.GetAllCategoriesAsync(c => c.UserId == guidId);
        }
    }

    private async Task UpdateColor(Category category, string color)
    {
        category.RGB_A = color;
        await CategoryRepository.UpdateAndSaveAsync(category);
    }

    private async Task HandleBezeichnungChange(EditContext context, Category changedCategory)
    {
        var valid = context.Validate();
        if (valid)
        {
            await ItemRepository.UpdateAndSaveAsync(changedCategory);
            BezeichnungEditEnabled = -1;
        }
    }

    private async Task IconChanged(Category changedCategory, string icon)
    {
        changedCategory.Icon = icon;
        await ItemRepository.UpdateAndSaveAsync(changedCategory);
    }

    private async Task RemoveCategory(int index)
    {
        //TODO Check einbauen (ob Items mit der Category existieren)
        index.Satisfies(i => i < AllCategories.Count);

        await ItemRepository.RemoveAndSaveAsync(AllCategories[index]);
        AllCategories.RemoveAt(index);
    }

    private void NavigateToNew()
    {
        if (ListId != null)
            NavigationManager.NavigateTo(NavigationManager.BaseUri + $"administration/categories/new/{ListId}");
        else
            NavigationManager.NavigateTo(NavigationManager.BaseUri + "administration/categories/new/categories");
    }
}
