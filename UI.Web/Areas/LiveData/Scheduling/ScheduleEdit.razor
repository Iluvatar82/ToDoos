@page "/schedule/{ListId:guid}/{ItemId:guid}"
@using Common = global::ToDo.Data.Common;
@using ToDo.Data.Common.Enums;

@if (ItemId != Guid.Empty)
{
    <h4>@Title - Scheduling bearbeiten</h4>

    <div class="row mb-3">
        <div class="btn-group col-3" role="group">
            <button type="button" @onclick="NavigateBack" class="btn btn-outline-secondary">Zurück</button>
            <button @onclick=@(() => CreateNew()) class="btn btn-outline-primary">Schedule Hinzufügen</button>
        </div>
    </div>
}
else
{
    <button type="button" @onclick=@(() => CreateNew()) class="btn btn-outline-primary">Schedule Hinzufügen</button>
}

<table class="table table-bordered">
    <thead>
        <tr>
            <th>
                Typ
            </th>

            <th>
                Definition
            </th>

            <th></th>
        </tr>
    </thead>

    <tbody>

    </tbody>
    @for (int index = 0; index < Schedules.Count; index++)
    {
        var currentIndex = index;
        var schedule = Schedules[currentIndex];
        if (string.IsNullOrWhiteSpace(schedule.ScheduleDefinition))
        {
            InvokeAsync(async () => await RemoveAt(currentIndex));
        }

        var scheduleDefinition = Common.Converter.ScheduleDefinitionConverter.Convert(schedule.ScheduleDefinition);
        <tr>
            <td class="align-top py-0">
                <div class="form-floating col py-0 px-2">
                    <select @bind:get=@((int)schedule.Type) @bind:set=@((int newType) => ChangeTo(currentIndex, newType)) class="form-control border" id="TypeSelect">
                        <option value="0">Fixer Zeitpunkt</option>
                        <option value="1">Wochentage</option>
                        <option value="2">Intervall</option>
                    </select>

                    <label for="TypeSelect">Scheduletyp</label>
                </div>
            </td>

            <td class="align-top py-0">
                @switch (schedule.Type)
                {
                    case Common.Enums.ScheduleType.Fixed:
                        <ScheduleFixed_Component Model=@scheduleDefinition.Fixed!.Date ModelChanged=@((value) => FixedValueChanged(schedule, value))></ScheduleFixed_Component>
                        break;

                    case Common.Enums.ScheduleType.WeekDays:
                        <ScheduleWeekdays_Component Model=@scheduleDefinition!.WeekDays Start=@schedule.Start End=@schedule.End ModelChanged=@((value) => WeekdaysValueChanged(schedule, value.Definition, value.Start, value.End))></ScheduleWeekdays_Component>
                        break;

                    case Common.Enums.ScheduleType.Interval:
                        <ScheduleInterval_Component Model=@scheduleDefinition!.Interval Start=@schedule.Start End=@schedule.End ModelChanged=@((value) => IntervalValueChanged(schedule, value.Definition, value.Start, value.End))></ScheduleInterval_Component>
                        break;
                }
            </td>

            <td class="fixed-w fade-in-on-hover">
                <span class="px-2 fa fa-xmark text-secondary opacity-25" aria-hidden="true" @onclick=@(() => RemoveAt(currentIndex))></span>
            </td>
        </tr>
    }
</table>

@code {
    [Parameter]
    public Guid ListId { get; set; }

    [Parameter]
    public Guid ItemId { get; set; }

    [Parameter]
    public EventCallback SchedulesChanged { get; set; }

    private string Title { get; set; } = "Keine Beschreibung";
    private List<Schedule> Schedules { get; set; } = new List<Schedule>();

    protected override async Task OnParametersSetAsync()
    {
        if (ItemId != Guid.Empty && ListId != Guid.Empty)
        {
            Title = (await ItemRepository.GetAsync<ToDoItem>(ItemId))?.Bezeichnung ?? Title;
            Schedules = await ItemRepository.GetAllAsync<Schedule>(s => s.ToDoItemId == ItemId);
         }
    }

    private int GetTypeFromDefinition(string definition)
    {
        if (definition[0] == 'd')
            return 0;

        if (definition[0] == 'w')
            return 1;

        if (definition[0] == 'i')
            return 2;

        return 0;
    }

    private async Task ChangeTo(int index, int newType)
    {
        switch (newType)
        {
            case 0:
                Schedules[index].ScheduleDefinition = Common.ScheduleFixed.Default;

                break;

            case 1:
                Schedules[index].ScheduleDefinition = Common.ScheduleWeekdays.Default;

                break;

            case 2:
                Schedules[index].ScheduleDefinition = Common.ScheduleInterval.Default;

                break;
        }

        await InvokeAsync(async () => {
            await SchedulesChanged.InvokeAsync(Schedules);
            StateHasChanged();
        });
    }

    private async Task RemoveAt(int index)
    {
        await ItemRepository.RemoveAndSaveAsync(Schedules[index]);
        Schedules.RemoveAt(index);

        await InvokeAsync(async () =>
        {
            await SchedulesChanged.InvokeAsync(Schedules);
            StateHasChanged();
        });
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo(NavigationManager.BaseUri + $"/list/{ListId}");
    }

    private async Task CreateNew()
    {
        var newSchedule = new Schedule() { ToDoItemId = ItemId, ScheduleDefinition = Common.ScheduleFixed.Default };
        Schedules.Add(newSchedule);

        if (ListId != Guid.Empty && ListId != Guid.Empty)
            await ItemRepository.AddAndSaveAsync(newSchedule);

        await InvokeAsync(async () =>
        {
            await SchedulesChanged.InvokeAsync(Schedules);
            StateHasChanged();
        });
    }

    private async Task FixedValueChanged(Schedule schedule, DateTime value)
    {
        schedule.ScheduleDefinition = Common.Converter.ScheduleDefinitionConverter.Convert(new Common.ScheduleDefinition(){ Fixed = value });
        if (ListId != Guid.Empty && ListId != Guid.Empty)
            await ItemRepository.UpdateAndSaveAsync(schedule);

        await InvokeAsync(async () =>
        {
            await SchedulesChanged.InvokeAsync(Schedules);
            StateHasChanged();
        });
    }

    private async Task WeekdaysValueChanged(Schedule schedule, Common.ScheduleWeekdays value, DateTime? start, DateTime? end)
    {
        schedule.ScheduleDefinition = Common.Converter.ScheduleDefinitionConverter.Convert(new Common.ScheduleDefinition() { WeekDays = value });
        
        schedule.Start = start;
        schedule.End = end;

        if (ListId != Guid.Empty && ListId != Guid.Empty)
            await ItemRepository.UpdateAndSaveAsync(schedule);

        await InvokeAsync(async () =>
        {
            await SchedulesChanged.InvokeAsync(Schedules);
            StateHasChanged();
        });
    }

    private async Task IntervalValueChanged(Schedule schedule, Common.ScheduleInterval value, DateTime? start, DateTime? end)
    {
        schedule.ScheduleDefinition = Common.Converter.ScheduleDefinitionConverter.Convert(new Common.ScheduleDefinition() { Interval = value,  });

        schedule.Start = start;
        schedule.End = end;

        if (ListId != Guid.Empty && ListId != Guid.Empty)
            await ItemRepository.UpdateAndSaveAsync(schedule);

        await InvokeAsync(async () =>
        {
            await SchedulesChanged.InvokeAsync(Schedules);
            StateHasChanged();
        });
    }
}